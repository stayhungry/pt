<html>
<head> 
<title>Sample File Upload Form</title> 
</head>
<body>

<h1>Sample File Upload Form</h1>
<h2>Please fill in the file-upload form below</h2>

<script type="text/javascript">
	var uploadUrl = 'http://10.10.36.118/upload?id=XC46LEr4oFL2a23drrPEA3eZRJcMRAE3TLjsZZR-SZ3AP-oILlqyxveR78UeNzGkKi0FaJk7iLuYfFVyI7ncITA~@n_u+ZS_DEIljl1TYeb4bWNaDftH9Ln2Mn0RLmIx83pI+bMIzlDHANWxYCQzhys8Oe5Sfm0H64kHp+8i9dWYuczwlWsAhLjQgwfVBlwJIZOZXtSqmgcxFdgl88l0bwacM6bjwfRlJ2m32pi6nXhl7F2EqkmoWZwbaf4rPHnkHVWjBXrL4gYuPcSANZNTjbZeDYYKpG2yi1HSHi3Q3iMLoRucKahBVtwY77QOT13pCG+ws2ugav9DdxRToEPtCBn1JH543XnVo8O91PZ+i+IH_qsPNGkHd1C6cklNWSWpTAStPHANKnou_QMZMRON8v1tlgYUEWm_fk6F273rrBYg8+389LV9x+sqa015e3+6Q8lR5C6SftUeMrf9OtwCFLh7ttzwm7tc3g9bP5B4uNWc+8BAKLvqHo5WQg4O5TKWdvBWm93xsu0g62T72HKNGDgDvAaaFckhFGOApR0x4kTc0SRxbQYm+DCaOr+YILLXdk6_G5kYNOjUtEbtoM9NbIKl8VQ_PpkWFWI5VRTTH2E_N3I35kakhY9hsdqzHN6ybYidLbp7dg6TQuipVDKd+5NcaMbh_G3_Iw4BYQEbL7r+UUiXjGJ9Y7w2L3sQbzxR6vMhPtpu6yQ+rVokfA2CK870Oo020TZkc15P+aqyEFRbTcpFdoulstulv3VAbX1ErkCQ+bMIzlDHANWxYCQzhys8OYbojZz7xPLyk0jzKmuuexq9ip8t1BB1mdRmSV1n756Xk7dVxyzSKAo9wppE53UOl6vnjsROy1MD4eeFiJdRzSaiISqdxxyt_NNKTOiJg740SWqhhvvctWyUN9ja1Vzs+iPXWv4+C1IzZ8TiTh58leTJ4pn3Q2DsiRTGV827J+S26xInWfVNxgCbS7vtOLoLdVQ_PpkWFWI5VRTTH2E_N3I35kakhY9hsdqzHN6ybYidLbp7dg6TQuipVDKd+5Nca6xxqW2+YF0bOGEDKjUjz62OWe4evyjqIe_k78sbhpJH3JBC6QSW5O6MIeTqpGg40fQaOTrul2+l1bbsIsGxhOEaEtlA6rKnwiLdEOTNl2ffbZV9O+OqZDSWarUuP4dmeZoe2dHrvbjLrjQYT0vrkCG6ANhU0SqgeWdtzI5DFfykvWzj2JKw4BoyrNo4r201SpOKjY70fNmPYqjQJ2awXg0aEtlA6rKnwiLdEOTNl2ffbZV9O+OqZDSWarUuP4dmeZoe2dHrvbjLrjQYT0vrkCE_n3TqU5ATtULbGj9WID4mrx0QJSC9U6N0_EU9weneyLgx6E5YPOI72gE5DmDp_rVv31iWjzerMBSEtDwcphOgQilqzdda+FSCLiVdN1o1Gv7PGCvjg_Rk2s3_2DCSOL7HOpUAJy4Fzm+tffFvoVAPyonItDKh7Rn0u4t4HF0n4KXqgQrlFn3ghK9_Ip5rqm+bxKS+YRFIInVszEBHnMZZdmbWl4_rrKIMyGFlkiOBV1iIw4C2zJ9MXisNbqHbMWBIrMuO10LP787ecov0EDuw';

	function submitform() {
		var file = document.getElementById('file').files[0];
		var fileSize = file.size;
		//var fileName = file.name;
	 	var fileName = '' + new Date().getTime();
		var uploadQueue = createQueue();
	 	const BYTES_PER_CHUNK = 1 * 1024 * 1024; // 1MB chunk sizes.
  	var start = 0;
  	var end = BYTES_PER_CHUNK;
	  while(start < fileSize) {
	    if (end > fileSize){
	    	end = fileSize;
	    }
	    if ('mozSlice' in file) {
	      var contentChunk = file.mozSlice(start, end);
	    } else {
	      var contentChunk = file.webkitSlice(start, end);
	    }
			var contentRange = "bytes " + start + "-" + end + "/" + fileSize;
			console.log("DEBUG: upload chunk range: " + contentRange);
		  uploadFileChunk(contentChunk, contentRange, fileName);
	
	    start = end;
	    end = start + BYTES_PER_CHUNK;
	  }
	}

	function uploadFileChunk(chunk, range, fileName) {
	
		var reader = new FileReader();
		//bind the events
		reader.onloadend = function(e) {
			if (e.target.readyState == FileReader.DONE) {
				var data = e.target.result;
				var xhr = new XMLHttpRequest();
		    //xhr.upload.addEventListener("progress", function(evt){uploadComplete(evt, range)}, false);
		    xhr.addEventListener("load", function(evt){uploadComplete(evt, range)}, false);
    		xhr.addEventListener("error", function(evt){uploadFailed(evt, range)}, false);
    		xhr.addEventListener("abort", function(evt){uploadCanceled(evt, range)}, false);
				xhr.open('POST', uploadUrl, true);
				xhr.setRequestHeader("X-Content-Range", range);
				xhr.setRequestHeader("Session-ID", fileName);
				xhr.setRequestHeader("Content-Type", "application/octet-stream");
				xhr.setRequestHeader("Content-Disposition", 'attachment; name="file"; filename="big.TXT"');
				xhr.send(data);
		  }
		};
		reader.readAsBinaryString(chunk);
	}
	
  function uploadComplete(evt, range) {
			console.log("DEBUG: upload completed for chunk range : " + range);
  }  
	
  function uploadFailed(evt, range) {
			console.log("DEBUG: upload failed for chunk range : " + range);
  }  

  function uploadCanceled(evt, range) {
			console.log("DEBUG: upload aborted for chunk range : " + range);
  }  


	function createQueue (){
	
	  var queue  = [];
	  var offset = 0;
	
		var that = {};
		
	  that.getLength = function(){
	    return (queue.length - offset);
	  }
	
	  that.isEmpty = function(){
	    return (queue.length == 0);
	  }
	
	  that.enqueue = function(item){
	    queue.push(item);
	  }
	
	  that.dequeue = function(){
	    if (queue.length == 0) return undefined;
	    var item = queue[offset];
	    // increment the offset and remove the free space if necessary
	    if (++ offset * 2 >= queue.length){
	      queue  = queue.slice(offset);
	      offset = 0;
	    }
	    return item;
	  }
	
	  that.peek = function(){
	    return (queue.length > 0 ? queue[offset] : undefined);
	  }
	
		return that;
	}
	
</script>

<form name="myform" method='POST' enctype='multipart/form-data'>
	File to upload: <input type="file" name="file" id="file">
	<br><br>
	<a href="javascript: submitform()">Submit</a>
</form>

</body>
</html>
