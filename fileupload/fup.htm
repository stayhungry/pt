<!DOCTYPE html>
<html>
<head>
	<title>File Upload using HTML5 with Flash fallback</title>

	<script type="text/javascript" src="fup/nysi.core.js"></script>
	<script type="text/javascript" src="fup/modernizr.custom.js"></script>
	<script type="text/javascript">
		yepnope.errorTimeout = 2000; // set to 2 seconds error timeout
	</script>

	<!-- for performance, let us leverage CDN or user's existing cache first,  with fallback to our own server -->
	<script type="text/javascript">
		Modernizr.load([
			{
			  load: 'http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js',
			  callback: function(url, result, key){
			    if (window.jQuery) {
				    console.log('loading from Google API succeeded,  app starts. ');
				    initApp();
			    }
			    else{
			    	console.log('loading from Google API failed,  loading from our server instead');
			      Modernizr.load({
			      	load: 'fup/jquery-1.6.2.min.js',
						  callback: function(url, result, key){
						    if (window.jQuery) {
							    console.log('loading from our server succeeded,  app starts. ');
							    initApp();
						    }
						    else{
							    alert('Please refresh the page. ');
						    }
						  }
						})
			    }
			  }
			}
		]);		
	</script>

	<style>
	.html-polyfills { display: none; }
	</style>

</head>

<body>

<div id="html5-impl" class="html-polyfills"> 
	<form id="fup-form">
	    <input type="file" id="file-to-upload" multiple/>
	    <br/>
	    <input type="button" id="btn-upload" value="Upload" />
	</form>
	<div id="fup-info">
	  <div id="file-info">
	    <div id="file-name"></div>
	    <div id="file-size"></div>
	    <div id="file-type"></div>
	  </div>
	  <div id="progress-indicator">
	    <div id="progress-bar" class="floatLeft"></div>
	    <div id="progress-number" class="floatRight">&nbsp;</div>
	    <div class="clear"></div>
	    <div>
	      <div id="transfer-speed-info" class="floatLeft" style="width: 80px;">&nbsp;</div>
	      <div id="time-remaining-info" class="floatLeft" style="margin-left: 10px;">&nbsp;</div>
	      <div id="transfer-bytes-info" class="floatRight" style="text-align: right;">&nbsp;</div>
	      <div class="clear"></div>
	    </div>    
	    <div id="upload-response"></div>
	  </div>  
	</div>
</div>

<!-- 3 musts:  client-side:  id="file_upload" and "fileName" can't be used as selector id;  server-side: $file_id='Filedata' -->
<div id="flash-impl" class="html-polyfills"> 
	<input type="file" id="file_upload" />
	<input type="button" id="btn_upload" value="Upload" />
</div>

<script type="text/javascript">

	function initApp(){
  	pathToUpload = "http://mylaptop/pt/fileupload/fup.php"
		var featureTest = !!window.FileReader && Modernizr.draganddrop;
		var resHtml5 = ['fup/nysi.html5.js'];
		var resPolyfill = ['uploadify/swfobject.js', 'uploadify/jquery.uploadify.v2.1.4.min.js', 'uploadify/uploadify.css', 'fup/nysi.flash.js'];
		
		$(function(){
			Modernizr.load({
			  test: featureTest,
			  yep: resHtml5,
			  nope: resPolyfill,
			  callback: function (url, result, key){
			    if (url === resHtml5[resHtml5.length - 1]) {
			      console.log('using HTML5!');
			      initHtml5();
			    }
			    else if (url === resPolyfill[resPolyfill.length - 1]){
			      console.log('using Polyfill!');
	     			initPolyfill();
			    }
			  }
			});
		});
	}

	function initHtml5(){
		$('#html5-impl').show();
		var nysiFileUpload = NYSI.html5.filemgr.bootstrap();	
		$('#file-to-upload').bind({
			change: function(e) {
				nysiFileUpload.fileSelected();
				e.preventDefault();
			}
		});
		$('#btn-upload').bind({
			click: function(e) {
				nysiFileUpload.uploadFiles();
			}
		});
	}

	function initPolyfill(){
		$('#flash-impl').show();
		NYSI.flash.filemgr.bootstrap();
		$('#btn_upload').bind({
			click: function(e) {
				$('#file_upload').uploadifyUpload();
			}
		});
	}
	

</script>

</body>
</html>
